<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SpotMap - Tes moments en carte üó∫Ô∏è</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3BvdE1hcCIsInNob3J0X25hbWUiOiJTcG90TWFwIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZjZiOWQiLCJ0aGVtZV9jb2xvciI6IiNmZjZiOWQiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0UlRjAlOUYlOTMlOEQlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-attachment: fixed;
            color: #2d3748;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .animate-bounce {
            animation: bounceIn 0.5s ease-out forwards;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            padding: 1.5rem 1rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(255, 107, 157, 0.3);
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .profile-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            border: 3px solid #ffd6e7;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .profile-btn:active {
            transform: scale(0.9);
        }

        /* Container */
        .container {
            padding: 1.5rem 1rem;
            padding-bottom: 100px;
            max-width: 600px;
            margin: 0 auto;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Category Cards */
        .categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .category-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.5) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .category-card:hover::before {
            opacity: 1;
        }

        .category-card:active {
            transform: scale(0.95);
        }

        .category-card.spot {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .category-card.love {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
            position: relative;
        }

        .category-card.love .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            font-size: 2rem;
            backdrop-filter: blur(5px);
        }

        .category-card.resto {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .category-card.bar {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }

        .category-card .icon {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
            transition: transform 0.3s;
        }

        .category-card:hover .icon {
            transform: scale(1.2) rotate(10deg);
        }

        .category-card .label {
            font-size: 1.1rem;
            font-weight: 700;
            color: rgba(0,0,0,0.8);
            margin-bottom: 0.25rem;
        }

        .category-card .count {
            font-size: 1.5rem;
            font-weight: 800;
            color: rgba(0,0,0,0.6);
        }

        /* Stats Card */
        .stats-card {
            background: white;
            border-radius: 25px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stats-card h2 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 2px solid #f7fafc;
            align-items: center;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #4a5568;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Add Button */
        .add-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            box-shadow: 0 15px 35px rgba(255, 107, 157, 0.4);
            position: fixed;
            bottom: 90px;
            right: 1.5rem;
            z-index: 50;
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }

        .add-btn:active {
            transform: scale(0.9);
            animation: none;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 0.75rem 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }

        .nav-btn {
            background: none;
            border: none;
            color: #cbd5e0;
            font-size: 1.5rem;
            padding: 0.5rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            border-radius: 15px;
        }

        .nav-btn span {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .nav-btn.active {
            color: #ff6b9d;
            background: rgba(255, 107, 157, 0.1);
            transform: translateY(-5px);
        }

        /* Gallery */
        .gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .gallery-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .gallery-item .caption-preview {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 2rem 0.75rem 0.75rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeInUp 0.3s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            margin: 1rem;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: bounceIn 0.5s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            background: #f7fafc;
            border: none;
            color: #718096;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e2e8f0;
            transform: rotate(90deg);
        }

        /* Camera */
        .camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #camera, #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 5px solid #ff6b9d;
            cursor: pointer;
            margin: 1rem auto;
            display: block;
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.3);
        }

        .camera-btn:active {
            transform: scale(0.9);
        }

        /* Category Selector */
        .category-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .category-btn {
            background: #f7fafc;
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 1rem 0.5rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .category-btn.selected {
            border-width: 3px;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .category-btn.spot.selected {
            border-color: #fdcb6e;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .category-btn.love.selected {
            border-color: #ff7675;
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
        }

        .category-btn.resto.selected {
            border-color: #00b894;
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .category-btn.bar.selected {
            border-color: #6c5ce7;
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }

        .category-btn .icon {
            font-size: 2rem;
        }

        .category-btn .label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
            color: #4a5568;
        }

        /* Input */
        .caption-input {
            width: 100%;
            padding: 1rem;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            color: #2d3748;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s;
        }

        .caption-input:focus {
            outline: none;
            border-color: #ff6b9d;
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        /* Save Button */
        .save-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(255, 107, 157, 0.3);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .save-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        /* Map */
        #map {
            width: 100%;
            height: calc(100vh - 250px);
            border-radius: 25px;
            margin-top: 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .leaflet-popup-content-wrapper {
            background: white;
            color: #2d3748;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 0;
            width: 220px !important;
        }

        .popup-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 20px 20px 0 0;
        }

        .popup-content {
            padding: 1rem;
        }

        .popup-category {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .popup-location {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 0.5rem;
        }

        .popup-caption {
            font-size: 0.8rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 2px solid #f7fafc;
            color: #4a5568;
        }

        .leaflet-popup-tip {
            background: white;
        }

        .custom-marker {
            background: none !important;
            border: none !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: white;
        }

        .empty-state .icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: bounceIn 1s ease-out;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* PIN Modal */
        .pin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 300;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .pin-modal.active {
            display: flex;
        }

        .pin-content {
            background: white;
            border-radius: 30px;
            padding: 2.5rem 2rem;
            max-width: 350px;
            width: 90%;
            text-align: center;
            animation: bounceIn 0.5s ease-out;
        }

        .pin-content h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: #ff6b9d;
        }

        .pin-content p {
            color: #718096;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .pin-display {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .pin-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s;
        }

        .pin-dot.filled {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            transform: scale(1.2);
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .pin-key {
            aspect-ratio: 1;
            border: none;
            background: #f7fafc;
            border-radius: 50%;
            font-size: 1.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            color: #2d3748;
        }

        .pin-key:active {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            color: white;
            transform: scale(0.95);
        }

        /* Profile View */
        .profile-header {
            background: white;
            border-radius: 25px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            margin-bottom: 1.5rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1rem;
            border: 5px solid #ffd6e7;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .profile-name {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-bio {
            color: #718096;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 1rem;
            border-top: 2px solid #f7fafc;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #ff6b9d;
        }

        .profile-stat-label {
            font-size: 0.8rem;
            color: #718096;
            font-weight: 600;
        }

        .profile-menu {
            background: white;
            border-radius: 25px;
            padding: 1rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            gap: 1rem;
        }

        .menu-item:hover {
            background: #f7fafc;
        }

        .menu-item-icon {
            font-size: 1.5rem;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(255, 142, 83, 0.1) 100%);
        }

        .menu-item-text {
            flex: 1;
        }

        .menu-item-title {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.2rem;
        }

        .menu-item-subtitle {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .menu-item-arrow {
            color: #cbd5e0;
            font-size: 1.2rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 280px;
            max-width: 90%;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast-icon {
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-weight: 600;
            color: #2d3748;
            line-height: 1.4;
        }

        /* Tag Friends Button */
        .tag-friends-btn {
            width: 100%;
            padding: 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            color: #4a5568;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Poppins', sans-serif;
        }

        .tag-friends-btn:hover {
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.05);
        }

        /* Friend List Item */
        .friend-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .friend-item:hover {
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.05);
        }

        .friend-item.selected {
            border-color: #ff6b9d;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(255, 142, 83, 0.1) 100%);
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.2rem;
        }

        .friend-username {
            font-size: 0.85rem;
            color: #718096;
        }

        .friend-check {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .friend-item.selected .friend-check {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            border-color: transparent;
            color: white;
        }

        /* Tagged Badge on Photos */
        .tagged-badge {
            position: absolute;
            bottom: 0.75rem;
            left: 0.75rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* Gallery Filters - Checkbox Style */
        .gallery-filter {
            background: white;
            border: none;
            border-radius: 15px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            width: 70px;
            justify-content: flex-start;
        }

        .gallery-filter:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .filter-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .filter-check {
            opacity: 0;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            transition: opacity 0.3s;
        }

        .gallery-filter.active .filter-checkbox {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%);
            border-color: transparent;
        }

        .gallery-filter.active .filter-check {
            opacity: 1;
        }

        .filter-icon {
            font-size: 1.8rem;
            transition: transform 0.3s;
        }

        .gallery-filter:hover .filter-icon {
            transform: scale(1.15);
        }

        /* Country Folders */
        .country-folder {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .country-folder:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .country-folder-flag {
            font-size: 3rem;
            width: 70px;
            height: 70px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f7fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .country-folder-info {
            flex: 1;
        }

        .country-folder-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .country-folder-count {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 600;
        }

        .country-folder-arrow {
            font-size: 1.5rem;
            color: #cbd5e0;
        }

        @media (max-width: 400px) {
            .categories {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">üìç SpotMap</div>
            <button class="profile-btn" onclick="switchView('profile')">üë§</button>
        </div>
    </div>

    <div class="container">
        <!-- Home View -->
        <div id="homeView" class="view active">
            <div class="categories">
                <div class="category-card spot animate-fade-in" onclick="goToCategory('spot')" style="animation-delay: 0.1s;">
                    <div class="icon">üåÖ</div>
                    <div class="label">Spots</div>
                    <div class="count"><span id="spotCount">0</span></div>
                </div>
                <div class="category-card love animate-fade-in" onclick="goToCategory('love')" style="animation-delay: 0.2s;">
                    <div class="icon">‚ù§Ô∏è</div>
                    <div class="label">Coquins</div>
                    <div class="count">üîí</div>
                    <div class="lock-overlay" id="loveLock">üîí</div>
                </div>
                <div class="category-card resto animate-fade-in" onclick="goToCategory('resto')" style="animation-delay: 0.3s;">
                    <div class="icon">üç¥</div>
                    <div class="label">Restos</div>
                    <div class="count"><span id="restoCount">0</span></div>
                </div>
                <div class="category-card bar animate-fade-in" onclick="goToCategory('bar')" style="animation-delay: 0.4s;">
                    <div class="icon">üç∫</div>
                    <div class="label">Bars</div>
                    <div class="count"><span id="barCount">0</span></div>
                </div>
            </div>

            <div class="stats-card animate-fade-in" style="animation-delay: 0.5s;">
                <h2>üìä Tes aventures</h2>
                <div class="stat-item">
                    <span class="stat-label">Total de moments</span>
                    <span class="stat-value" id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Villes explor√©es</span>
                    <span class="stat-value" id="citiesCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pays conquis</span>
                    <span class="stat-value" id="countriesCount">0</span>
                </div>
            </div>
        </div>

        <!-- Gallery View -->
        <div id="galleryView" class="view">
            <!-- Category Filters - Vertical Left Side -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; flex-direction: column; gap: 0.75rem; flex-shrink: 0;">
                    <button class="gallery-filter active" data-category="all" onclick="switchGalleryTab('all')">
                        <div class="filter-checkbox">
                            <span class="filter-check">‚úì</span>
                        </div>
                        <span class="filter-icon">üåü</span>
                    </button>
                    <button class="gallery-filter" data-category="spot" onclick="switchGalleryTab('spot')">
                        <div class="filter-checkbox">
                            <span class="filter-check">‚úì</span>
                        </div>
                        <span class="filter-icon">üåÖ</span>
                    </button>
                    <button class="gallery-filter" data-category="love" onclick="switchGalleryTab('love')">
                        <div class="filter-checkbox">
                            <span class="filter-check">‚úì</span>
                        </div>
                        <span class="filter-icon">‚ù§Ô∏è</span>
                    </button>
                    <button class="gallery-filter" data-category="resto" onclick="switchGalleryTab('resto')">
                        <div class="filter-checkbox">
                            <span class="filter-check">‚úì</span>
                        </div>
                        <span class="filter-icon">üç¥</span>
                    </button>
                    <button class="gallery-filter" data-category="bar" onclick="switchGalleryTab('bar')">
                        <div class="filter-checkbox">
                            <span class="filter-check">‚úì</span>
                        </div>
                        <span class="filter-icon">üç∫</span>
                    </button>
                </div>

                <div style="flex: 1; min-width: 0;">
                    <!-- Country Folders View -->
                    <div id="countryFoldersView" style="display: none;"></div>

                    <!-- Photos Grid View -->
                    <div id="galleryContainer" class="gallery"></div>
                    
                    <div id="emptyGallery" class="empty-state">
                        <div class="icon">üì∏</div>
                        <h3>Pas encore de moments</h3>
                        <p>Appuie sur + pour capturer ton premier spot !</p>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <button id="galleryBackBtn" style="display: none; position: fixed; bottom: 160px; right: 1.5rem; width: 60px; height: 60px; border-radius: 50%; background: white; border: none; font-size: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); cursor: pointer; z-index: 50;" onclick="backToCountryFolders()">
                ‚Üê
            </button>
        </div>

        <!-- Map View -->
        <div id="mapView" class="view">
            <!-- Map Header with Gallery Button -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #ff6b9d 0%, #ff8e53 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">üó∫Ô∏è Ta carte</h2>
                <button onclick="currentGalleryCategory = 'all'; switchView('gallery')" style="width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                    üì∑
                </button>
            </div>
            <div id="map"></div>
        </div>

        <!-- Profile View -->
        <div id="profileView" class="view">
            <div class="profile-header animate-fade-in">
                <div class="profile-avatar">üë§</div>
                <div class="profile-name">Ton Profil</div>
                <div class="profile-bio">Explorateur de spots üåç</div>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <div class="profile-stat-value">0</div>
                        <div class="profile-stat-label">Abonn√©s</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value">0</div>
                        <div class="profile-stat-label">Abonnements</div>
                    </div>
                    <div class="profile-stat">
                        <div class="profile-stat-value" id="profileMomentsCount">0</div>
                        <div class="profile-stat-label">Moments</div>
                    </div>
                </div>
            </div>

            <div class="profile-menu animate-fade-in" style="animation-delay: 0.2s;">
                <div class="menu-item" onclick="showToast('üë•', `Tu as ${friendsList.length} amis dans ta liste !`, 3000)">
                    <div class="menu-item-icon">üë•</div>
                    <div class="menu-item-text">
                        <div class="menu-item-title">Mes amis</div>
                        <div class="menu-item-subtitle">${friendsList.length} amis ¬∑ G√©rer ta liste</div>
                    </div>
                    <div class="menu-item-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="showToast('üîê', 'Fonctionnalit√© disponible dans la version compl√®te !', 3000)">
                    <div class="menu-item-icon">üîê</div>
                    <div class="menu-item-text">
                        <div class="menu-item-title">Code PIN</div>
                        <div class="menu-item-subtitle">Modifier ton code secret</div>
                    </div>
                    <div class="menu-item-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="showToast('üë•', 'Fonctionnalit√© disponible dans la version compl√®te !', 3000)">
                    <div class="menu-item-icon">üë•</div>
                    <div class="menu-item-text">
                        <div class="menu-item-title">D√©couvrir</div>
                        <div class="menu-item-subtitle">Explore les spots des autres</div>
                    </div>
                    <div class="menu-item-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="showToast('‚öôÔ∏è', 'Fonctionnalit√© disponible dans la version compl√®te !', 3000)">
                    <div class="menu-item-icon">‚öôÔ∏è</div>
                    <div class="menu-item-text">
                        <div class="menu-item-title">Param√®tres</div>
                        <div class="menu-item-subtitle">Confidentialit√© et pr√©f√©rences</div>
                    </div>
                    <div class="menu-item-arrow">‚Ä∫</div>
                </div>
                <div class="menu-item" onclick="showToast('üì§', 'Fonctionnalit√© disponible dans la version compl√®te !', 3000)">
                    <div class="menu-item-icon">üì§</div>
                    <div class="menu-item-text">
                        <div class="menu-item-title">Partager</div>
                        <div class="menu-item-subtitle">Inviter des amis</div>
                    </div>
                    <div class="menu-item-arrow">‚Ä∫</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Button -->
    <button class="add-btn" onclick="openAddModal()">+</button>

    <!-- Bottom Navigation -->
    <div class="nav">
        <button class="nav-btn active" onclick="switchView('home')">
            üè†
            <span>Accueil</span>
        </button>
        <button class="nav-btn" onclick="currentGalleryCategory = 'all'; switchView('gallery')">
            üì∑
            <span>Galerie</span>
        </button>
        <button class="nav-btn" onclick="switchView('map')">
            üó∫Ô∏è
            <span>Carte</span>
        </button>
    </div>

    <!-- Add Moment Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouveau moment ‚ú®</h2>
                <button class="close-btn" onclick="closeAddModal()">‚úï</button>
            </div>

            <div class="camera-container">
                <video id="camera" autoplay playsinline style="display: none;"></video>
                <img id="preview" style="display: none;">
            </div>

            <button class="camera-btn" id="captureBtn" onclick="capturePhoto()"></button>

            <div class="category-selector">
                <div class="category-btn spot" onclick="selectCategory('spot')">
                    <div class="icon">üåÖ</div>
                    <div class="label">Spot</div>
                </div>
                <div class="category-btn love" onclick="selectCategory('love')">
                    <div class="icon">‚ù§Ô∏è</div>
                    <div class="label">Coquin</div>
                </div>
                <div class="category-btn resto" onclick="selectCategory('resto')">
                    <div class="icon">üç¥</div>
                    <div class="label">Resto</div>
                </div>
                <div class="category-btn bar" onclick="selectCategory('bar')">
                    <div class="icon">üç∫</div>
                    <div class="label">Bar</div>
                </div>
            </div>

            <textarea 
                id="captionInput" 
                class="caption-input"
                placeholder="Raconte ce moment magique... ‚ú®"
            ></textarea>

            <!-- Tag Friends Section -->
            <div style="margin-top: 1rem;">
                <button type="button" class="tag-friends-btn" onclick="openFriendsTag()">
                    <span style="font-size: 1.2rem;">üë•</span>
                    <span id="tagBtnText">Taguer des amis</span>
                    <span id="taggedCount" style="display: none; margin-left: 0.5rem; background: rgba(255, 107, 157, 0.2); padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.85rem;"></span>
                </button>
            </div>

            <button class="save-btn" id="saveBtn" onclick="saveMoment()" disabled>
                üíæ Enregistrer le moment
            </button>
        </div>
    </div>

    <!-- Friends Tag Modal -->
    <div id="friendsTagModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>üë• Taguer des amis</h2>
                <button class="close-btn" onclick="closeFriendsTag()">‚úï</button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <input 
                    type="text" 
                    id="friendSearchInput" 
                    placeholder="üîç Rechercher un ami..."
                    style="width: 100%; padding: 0.75rem 1rem; background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 15px; font-family: 'Poppins', sans-serif; font-size: 0.95rem;"
                    oninput="filterFriendsList()"
                >
            </div>

            <div id="friendsListContainer" style="max-height: 400px; overflow-y: auto;"></div>

            <button class="save-btn" onclick="confirmFriendsTags()" style="margin-top: 1rem;">
                ‚úÖ Confirmer
            </button>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="pin-modal">
        <div class="pin-content">
            <h2>üîê Code Secret</h2>
            <p>Entre ton code PIN pour acc√©der aux moments coquins</p>
            
            <div class="pin-display">
                <div class="pin-dot" id="pin1"></div>
                <div class="pin-dot" id="pin2"></div>
                <div class="pin-dot" id="pin3"></div>
                <div class="pin-dot" id="pin4"></div>
            </div>

            <div class="pin-keypad">
                <button class="pin-key" onclick="addPinDigit('1')">1</button>
                <button class="pin-key" onclick="addPinDigit('2')">2</button>
                <button class="pin-key" onclick="addPinDigit('3')">3</button>
                <button class="pin-key" onclick="addPinDigit('4')">4</button>
                <button class="pin-key" onclick="addPinDigit('5')">5</button>
                <button class="pin-key" onclick="addPinDigit('6')">6</button>
                <button class="pin-key" onclick="addPinDigit('7')">7</button>
                <button class="pin-key" onclick="addPinDigit('8')">8</button>
                <button class="pin-key" onclick="addPinDigit('9')">9</button>
                <button class="pin-key" onclick="clearPin()">‚Üê</button>
                <button class="pin-key" onclick="addPinDigit('0')">0</button>
                <button class="pin-key" onclick="closePinModal()">‚úï</button>
            </div>
        </div>
    </div>

    <!-- Moment Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 id="detailCategory">Moment</h2>
                <button class="close-btn" onclick="closeDetailModal()">‚úï</button>
            </div>

            <div style="position: relative; width: 100%; aspect-ratio: 1; border-radius: 20px; overflow: hidden; margin-bottom: 1.5rem;">
                <img id="detailPhoto" style="width: 100%; height: 100%; object-fit: cover;" alt="moment">
            </div>

            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f7fafc; border-radius: 15px;">
                    <div style="font-size: 1.5rem;">üìç</div>
                    <div style="flex: 1;">
                        <div style="font-size: 0.75rem; color: #a0aec0; font-weight: 600; margin-bottom: 0.2rem;">LOCALISATION</div>
                        <div id="detailLocation" style="font-weight: 700; color: #2d3748;"></div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f7fafc; border-radius: 15px;">
                    <div style="font-size: 1.5rem;">üìÖ</div>
                    <div style="flex: 1;">
                        <div style="font-size: 0.75rem; color: #a0aec0; font-weight: 600; margin-bottom: 0.2rem;">DATE</div>
                        <div id="detailDate" style="font-weight: 700; color: #2d3748;"></div>
                    </div>
                </div>

                <div id="detailTaggedContainer" style="display: none; padding: 1rem; background: #f7fafc; border-radius: 15px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <div style="font-size: 1.5rem;">üë•</div>
                        <div style="font-size: 0.75rem; color: #a0aec0; font-weight: 600;">AVEC</div>
                    </div>
                    <div id="detailTagged" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                </div>

                <div id="detailCaptionContainer" style="display: none; padding: 1rem; background: #f7fafc; border-radius: 15px;">
                    <div style="font-size: 0.75rem; color: #a0aec0; font-weight: 600; margin-bottom: 0.5rem;">üìù L√âGENDE</div>
                    <div id="detailCaption" style="color: #2d3748; line-height: 1.6;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let stream = null;
        let capturedPhoto = null;
        let selectedCategory = null;
        let currentPosition = null;
        let moments = [];
        let mapInstance = null;
        let markers = [];
        let currentPin = '';
        let userPin = '1234'; // Default PIN - in production, this would be user-configurable
        let isLoveUnlocked = false;
        let currentGalleryCategory = 'all';
        let currentGalleryCountry = null;
        let selectedGalleryCategories = []; // For multi-select
        let taggedFriends = [];
        let tempTaggedFriends = [];

        // Mock friends list (in production, this would come from backend)
        let friendsList = [
            { id: 1, name: 'Sophie Martin', username: '@sophie_m', avatar: 'üë©' },
            { id: 2, name: 'Lucas Dubois', username: '@lucas.d', avatar: 'üë®' },
            { id: 3, name: 'Emma Petit', username: '@emma_p', avatar: 'üë±‚Äç‚ôÄÔ∏è' },
            { id: 4, name: 'Thomas Bernard', username: '@thomas.b', avatar: 'üßî' },
            { id: 5, name: 'Chlo√© Rousseau', username: '@chloe_r', avatar: 'üë©‚Äçü¶∞' },
            { id: 6, name: 'Alexandre Laurent', username: '@alex.l', avatar: 'üë®‚Äçü¶±' },
            { id: 7, name: 'L√©a Moreau', username: '@lea_m', avatar: 'üë©‚Äçü¶≥' },
            { id: 8, name: 'Nicolas Simon', username: '@nico.s', avatar: 'üë®‚Äçüíº' },
            { id: 9, name: 'Marie Leroy', username: '@marie_l', avatar: 'üë©‚Äçüíª' },
            { id: 10, name: 'Pierre Garcia', username: '@pierre.g', avatar: 'üë®‚Äçüé®' }
        ];

        // Category configuration
        const categoryConfig = {
            spot: { icon: 'üåÖ', label: 'Spot', color: '#fdcb6e' },
            love: { icon: '‚ù§Ô∏è', label: 'Coquin', color: '#ff7675' },
            resto: { icon: 'üç¥', label: 'Resto', color: '#00b894' },
            bar: { icon: 'üç∫', label: 'Bar', color: '#6c5ce7' }
        };

        // Toast notification system
        function showToast(icon, message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            
            toastIcon.textContent = icon;
            toastMessage.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Friends tagging system
        function openFriendsTag() {
            document.getElementById('friendsTagModal').classList.add('active');
            tempTaggedFriends = [...taggedFriends];
            renderFriendsList();
        }

        function closeFriendsTag() {
            document.getElementById('friendsTagModal').classList.remove('active');
            document.getElementById('friendSearchInput').value = '';
        }

        function renderFriendsList(filter = '') {
            const container = document.getElementById('friendsListContainer');
            container.innerHTML = '';

            const filteredFriends = filter 
                ? friendsList.filter(f => 
                    f.name.toLowerCase().includes(filter.toLowerCase()) || 
                    f.username.toLowerCase().includes(filter.toLowerCase())
                  )
                : friendsList;

            filteredFriends.forEach(friend => {
                const isSelected = tempTaggedFriends.includes(friend.id);
                const item = document.createElement('div');
                item.className = `friend-item ${isSelected ? 'selected' : ''}`;
                item.onclick = () => toggleFriendTag(friend.id);
                
                item.innerHTML = `
                    <div class="friend-avatar">${friend.avatar}</div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.name}</div>
                        <div class="friend-username">${friend.username}</div>
                    </div>
                    <div class="friend-check">${isSelected ? '‚úì' : ''}</div>
                `;
                
                container.appendChild(item);
            });

            if (filteredFriends.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: #a0aec0;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                        <p>Aucun ami trouv√©</p>
                    </div>
                `;
            }
        }

        function toggleFriendTag(friendId) {
            const index = tempTaggedFriends.indexOf(friendId);
            if (index > -1) {
                tempTaggedFriends.splice(index, 1);
            } else {
                tempTaggedFriends.push(friendId);
            }
            renderFriendsList(document.getElementById('friendSearchInput').value);
        }

        function filterFriendsList() {
            const filter = document.getElementById('friendSearchInput').value;
            renderFriendsList(filter);
        }

        function confirmFriendsTags() {
            taggedFriends = [...tempTaggedFriends];
            updateTagButton();
            closeFriendsTag();
        }

        function updateTagButton() {
            const count = taggedFriends.length;
            const countSpan = document.getElementById('taggedCount');
            const textSpan = document.getElementById('tagBtnText');
            
            if (count > 0) {
                textSpan.textContent = `${count} ami${count > 1 ? 's' : ''} tagu√©${count > 1 ? 's' : ''}`;
                countSpan.textContent = `üë• ${count}`;
                countSpan.style.display = 'inline-block';
            } else {
                textSpan.textContent = 'Taguer des amis';
                countSpan.style.display = 'none';
            }
        }

        // Initialize app
        async function init() {
            loadMoments();
            updateStats();
            updateGallery();
            
            // Load user PIN if exists
            const savedPin = localStorage.getItem('spotmap_pin');
            if (savedPin) {
                userPin = savedPin;
            }
            
            // Request location permission
            if ('geolocation' in navigator) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('Position obtenue:', currentPosition);
                } catch (error) {
                    console.error('Erreur g√©olocalisation:', error);
                }
            }
        }

        // Category navigation from home
        function goToCategory(category) {
            // Check PIN for love category
            if (category === 'love' && !isLoveUnlocked) {
                openPinModal();
                return;
            }

            // Reset multi-select and go to single category
            selectedGalleryCategories = [];
            
            // Go to gallery view with this specific category
            switchView('gallery');
            switchGalleryTab(category);
        }

        // PIN Management
        function accessLoveCategory() {
            if (isLoveUnlocked) {
                goToCategory('love');
            } else {
                openPinModal();
            }
        }

        function openPinModal() {
            document.getElementById('pinModal').classList.add('active');
            currentPin = '';
            updatePinDisplay();
        }

        function closePinModal() {
            document.getElementById('pinModal').classList.remove('active');
            currentPin = '';
            updatePinDisplay();
        }

        function addPinDigit(digit) {
            if (currentPin.length < 4) {
                currentPin += digit;
                updatePinDisplay();
                
                if (currentPin.length === 4) {
                    checkPin();
                }
            }
        }

        function clearPin() {
            if (currentPin.length > 0) {
                currentPin = currentPin.slice(0, -1);
                updatePinDisplay();
            }
        }

        function updatePinDisplay() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`pin${i}`);
                if (i <= currentPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }

        function checkPin() {
            if (currentPin === userPin) {
                isLoveUnlocked = true;
                document.getElementById('loveLock').style.display = 'none';
                closePinModal();
                setTimeout(() => {
                    goToCategory('love');
                    showToast('‚ú®', 'Section coquine d√©verrouill√©e !');
                }, 300);
            } else {
                // Wrong PIN - shake animation and reset
                const pinContent = document.querySelector('.pin-content');
                pinContent.style.animation = 'none';
                setTimeout(() => {
                    pinContent.style.animation = 'bounceIn 0.5s ease-out';
                }, 10);
                
                setTimeout(() => {
                    currentPin = '';
                    updatePinDisplay();
                    showToast('‚ùå', 'Code incorrect !');
                }, 500);
            }
        }

        // View switching
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if (view === 'home') {
                document.getElementById('homeView').classList.add('active');
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            } else if (view === 'gallery') {
                document.getElementById('galleryView').classList.add('active');
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
                
                // If coming from nav button (not from category), reset to 'all' filter
                if (!currentGalleryCategory || view === 'gallery-full') {
                    currentGalleryCategory = 'all';
                    selectedGalleryCategories = [];
                    document.querySelectorAll('.gallery-filter').forEach(filter => {
                        filter.classList.toggle('active', filter.dataset.category === 'all');
                    });
                }
                
                updateGallery();
            } else if (view === 'map') {
                document.getElementById('mapView').classList.add('active');
                document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
                setTimeout(() => initMap(), 100);
            } else if (view === 'profile') {
                document.getElementById('profileView').classList.add('active');
                document.getElementById('profileMomentsCount').textContent = moments.length;
            }
        }

        // Modal management
        async function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            selectedCategory = null;
            capturedPhoto = null;
            taggedFriends = [];
            updateTagButton();
            document.getElementById('captionInput').value = '';
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('preview').style.display = 'none';
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                const camera = document.getElementById('camera');
                camera.srcObject = stream;
                camera.style.display = 'block';
            } catch (error) {
                showToast('üì∑', 'Impossible d\'acc√©der √† la cam√©ra. V√©rifie les autorisations.', 4000);
                closeAddModal();
            }
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // Photo capture
        function capturePhoto() {
            const camera = document.getElementById('camera');
            const preview = document.getElementById('preview');
            
            const canvas = document.createElement('canvas');
            canvas.width = camera.videoWidth;
            canvas.height = camera.videoHeight;
            canvas.getContext('2d').drawImage(camera, 0, 0);
            
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.85);
            preview.src = capturedPhoto;
            preview.style.display = 'block';
            camera.style.display = 'none';
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            checkSaveButton();
        }

        // Category selection
        function selectCategory(category) {
            selectedCategory = category;
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`.category-btn.${category}`).classList.add('selected');
            checkSaveButton();
        }

        // Check if save button should be enabled
        function checkSaveButton() {
            document.getElementById('saveBtn').disabled = !(capturedPhoto && selectedCategory);
        }

        // Save moment
        async function saveMoment() {
            if (!capturedPhoto || !selectedCategory) return;

            const caption = document.getElementById('captionInput').value.trim();

            // Get current position
            let position = currentPosition;
            if (!position) {
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    position = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    };
                } catch (error) {
                    // Use confirm for this one as it requires user decision
                    const useAnyway = confirm('Impossible de r√©cup√©rer ta position GPS. Veux-tu enregistrer le moment quand m√™me ?');
                    if (!useAnyway) return;
                    position = null;
                }
            }

            // Get location name
            let locationName = 'Localisation inconnue';
            let city = 'Ville inconnue';
            let country = 'Pays inconnu';
            
            if (position) {
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.lat}&lon=${position.lng}&accept-language=fr`,
                        {
                            headers: {
                                'User-Agent': 'SpotMap/1.0'
                            }
                        }
                    );
                    const data = await response.json();
                    
                    city = data.address.city || data.address.town || data.address.village || 'Ville inconnue';
                    country = data.address.country || 'Pays inconnu';
                    locationName = `${city}, ${country}`;
                } catch (error) {
                    console.error('Erreur geocoding:', error);
                }
            }

            const moment = {
                id: Date.now(),
                photo: capturedPhoto,
                category: selectedCategory,
                position: position,
                location: locationName,
                city: city,
                country: country,
                caption: caption,
                taggedFriends: taggedFriends.map(id => {
                    const friend = friendsList.find(f => f.id === id);
                    return friend ? { id: friend.id, name: friend.name, username: friend.username, avatar: friend.avatar } : null;
                }).filter(f => f !== null),
                date: new Date().toISOString()
            };

            moments.push(moment);
            saveMoments();
            updateStats();
            updateGallery();
            
            closeAddModal();
            
            // Show success toast
            const categoryLabel = categoryConfig[selectedCategory].label;
            showToast(categoryConfig[selectedCategory].icon, `${categoryLabel} enregistr√© √† ${locationName} !`, 4000);
            
            setTimeout(() => switchView('gallery'), 500);
        }

        // Storage management
        function saveMoments() {
            localStorage.setItem('spotmap_moments', JSON.stringify(moments));
        }

        function loadMoments() {
            const saved = localStorage.getItem('spotmap_moments');
            if (saved) {
                moments = JSON.parse(saved);
            }
        }

        // Update statistics
        function updateStats() {
            const counts = {
                spot: 0,
                love: 0,
                resto: 0,
                bar: 0
            };

            const cities = new Set();
            const countries = new Set();

            moments.forEach(moment => {
                counts[moment.category]++;
                if (moment.city && moment.city !== 'Ville inconnue') cities.add(moment.city);
                if (moment.country && moment.country !== 'Pays inconnu') countries.add(moment.country);
            });

            document.getElementById('spotCount').textContent = counts.spot;
            document.getElementById('restoCount').textContent = counts.resto;
            document.getElementById('barCount').textContent = counts.bar;
            document.getElementById('totalCount').textContent = moments.length;
            document.getElementById('citiesCount').textContent = cities.size;
            document.getElementById('countriesCount').textContent = countries.size;
            
            // Keep love count hidden
            // Only show count if unlocked (future feature for premium)
        }

        // Gallery management with multi-select
        function switchGalleryTab(category) {
            // Check if trying to access love category without unlock
            if (category === 'love' && !isLoveUnlocked) {
                openPinModal();
                return;
            }

            // Handle "all" category - exclusive mode
            if (category === 'all') {
                currentGalleryCategory = 'all';
                selectedGalleryCategories = [];
                
                // Update all filters
                document.querySelectorAll('.gallery-filter').forEach(filter => {
                    if (filter.dataset.category === 'all') {
                        filter.classList.add('active');
                    } else {
                        filter.classList.remove('active');
                    }
                });
            } else {
                // Multi-select mode for specific categories
                // Deactivate "all" first
                document.querySelector('.gallery-filter[data-category="all"]').classList.remove('active');
                
                const filter = document.querySelector(`.gallery-filter[data-category="${category}"]`);
                
                // Toggle this category
                if (selectedGalleryCategories.includes(category)) {
                    // Remove from selection
                    selectedGalleryCategories = selectedGalleryCategories.filter(c => c !== category);
                    filter.classList.remove('active');
                } else {
                    // Add to selection
                    selectedGalleryCategories.push(category);
                    filter.classList.add('active');
                }
                
                // If no categories selected, revert to "all"
                if (selectedGalleryCategories.length === 0) {
                    currentGalleryCategory = 'all';
                    document.querySelector('.gallery-filter[data-category="all"]').classList.add('active');
                } else {
                    currentGalleryCategory = 'multi';
                }
            }

            currentGalleryCountry = null;
            showCountryFolders();
        }

        function showCountryFolders() {
            const foldersView = document.getElementById('countryFoldersView');
            const galleryContainer = document.getElementById('galleryContainer');
            const emptyGallery = document.getElementById('emptyGallery');
            const backBtn = document.getElementById('galleryBackBtn');

            // Filter moments by category (multi-select support)
            let filteredMoments;
            if (currentGalleryCategory === 'all') {
                filteredMoments = moments;
            } else if (currentGalleryCategory === 'multi') {
                filteredMoments = moments.filter(m => selectedGalleryCategories.includes(m.category));
            } else {
                filteredMoments = moments.filter(m => m.category === currentGalleryCategory);
            }

            if (filteredMoments.length === 0) {
                foldersView.style.display = 'none';
                galleryContainer.style.display = 'none';
                emptyGallery.style.display = 'block';
                backBtn.style.display = 'none';
                return;
            }

            // Group moments by country
            const momentsByCountry = {};
            filteredMoments.forEach(moment => {
                const country = moment.country || 'Pays inconnu';
                if (!momentsByCountry[country]) {
                    momentsByCountry[country] = [];
                }
                momentsByCountry[country].push(moment);
            });

            const countries = Object.keys(momentsByCountry).sort();

            // If only one country, show photos directly
            if (countries.length === 1) {
                currentGalleryCountry = countries[0];
                showCountryPhotos(countries[0]);
                return;
            }

            // Show country folders
            foldersView.style.display = 'block';
            galleryContainer.style.display = 'none';
            emptyGallery.style.display = 'none';
            backBtn.style.display = 'none';

            foldersView.innerHTML = '';

            countries.forEach((country, index) => {
                const count = momentsByCountry[country].length;
                const folder = document.createElement('div');
                folder.className = 'country-folder animate-fade-in';
                folder.style.animationDelay = `${index * 0.1}s`;
                folder.onclick = () => showCountryPhotos(country);

                // Get country flag emoji (simplified - in production use a proper mapping)
                const flag = getCountryFlag(country);

                folder.innerHTML = `
                    <div class="country-folder-flag">${flag}</div>
                    <div class="country-folder-info">
                        <div class="country-folder-name">${country}</div>
                        <div class="country-folder-count">${count} moment${count > 1 ? 's' : ''}</div>
                    </div>
                    <div class="country-folder-arrow">‚Ä∫</div>
                `;

                foldersView.appendChild(folder);
            });
        }

        function showCountryPhotos(country) {
            currentGalleryCountry = country;

            const foldersView = document.getElementById('countryFoldersView');
            const galleryContainer = document.getElementById('galleryContainer');
            const emptyGallery = document.getElementById('emptyGallery');
            const backBtn = document.getElementById('galleryBackBtn');

            // Filter moments by category (multi-select support)
            let filteredMoments;
            if (currentGalleryCategory === 'all') {
                filteredMoments = moments;
            } else if (currentGalleryCategory === 'multi') {
                filteredMoments = moments.filter(m => selectedGalleryCategories.includes(m.category));
            } else {
                filteredMoments = moments.filter(m => m.category === currentGalleryCategory);
            }
            
            // Then filter by country
            filteredMoments = filteredMoments.filter(m => (m.country || 'Pays inconnu') === country);

            // Show photos
            foldersView.style.display = 'none';
            galleryContainer.style.display = 'grid';
            emptyGallery.style.display = 'none';

            // Show back button if there are multiple countries
            const allCountries = new Set();
            let checkMoments;
            if (currentGalleryCategory === 'all') {
                checkMoments = moments;
            } else if (currentGalleryCategory === 'multi') {
                checkMoments = moments.filter(m => selectedGalleryCategories.includes(m.category));
            } else {
                checkMoments = moments.filter(m => m.category === currentGalleryCategory);
            }
            checkMoments.forEach(m => allCountries.add(m.country || 'Pays inconnu'));
            
            if (allCountries.size > 1) {
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }

            // Render photos
            galleryContainer.innerHTML = '';
            filteredMoments.reverse().forEach((moment, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item animate-fade-in';
                item.style.animationDelay = `${index * 0.1}s`;
                item.onclick = () => showMomentDetails(moment);
                
                const taggedBadge = moment.taggedFriends && moment.taggedFriends.length > 0 
                    ? `<div class="tagged-badge">üë• ${moment.taggedFriends.length}</div>` 
                    : '';
                
                item.innerHTML = `
                    <img src="${moment.photo}" alt="${moment.category}">
                    <div class="badge">${categoryConfig[moment.category].icon}</div>
                    ${taggedBadge}
                    ${moment.caption ? `<div class="caption-preview">${moment.caption.substring(0, 60)}${moment.caption.length > 60 ? '...' : ''}</div>` : ''}
                `;
                galleryContainer.appendChild(item);
            });
        }

        function backToCountryFolders() {
            currentGalleryCountry = null;
            showCountryFolders();
        }

        function getCountryFlag(countryName) {
            // Simplified country to flag mapping
            const flagMap = {
                'France': 'üá´üá∑',
                'Espagne': 'üá™üá∏',
                'Italie': 'üáÆüáπ',
                'Allemagne': 'üá©üá™',
                'Royaume-Uni': 'üá¨üáß',
                '√âtats-Unis': 'üá∫üá∏',
                'Canada': 'üá®üá¶',
                'Belgique': 'üáßüá™',
                'Suisse': 'üá®üá≠',
                'Portugal': 'üáµüáπ',
                'Pays-Bas': 'üá≥üá±',
                'Gr√®ce': 'üá¨üá∑',
                'Japon': 'üáØüáµ',
                'Australie': 'üá¶üá∫',
                'Br√©sil': 'üáßüá∑',
                'Mexique': 'üá≤üáΩ',
                'Tha√Ølande': 'üáπüá≠',
                'Maroc': 'üá≤üá¶',
                'Turquie': 'üáπüá∑',
                'Argentine': 'üá¶üá∑'
            };

            return flagMap[countryName] || 'üåç';
        }

        // Update gallery - simplified now that we have filters
        function updateGallery(filter = null) {
            if (filter) {
                // Legacy support for old filterGallery calls - single category mode
                selectedGalleryCategories = [];
                currentGalleryCategory = filter;
                currentGalleryCountry = null;

                // Update filter
                document.querySelectorAll('.gallery-filter').forEach(f => {
                    if (f.dataset.category === filter) {
                        f.classList.add('active');
                    } else {
                        f.classList.remove('active');
                    }
                });
            }

            showCountryFolders();
        }

        function showMomentDetails(moment) {
            const date = new Date(moment.date);
            const formattedDate = date.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Populate modal
            document.getElementById('detailCategory').innerHTML = `${categoryConfig[moment.category].icon} ${categoryConfig[moment.category].label}`;
            document.getElementById('detailPhoto').src = moment.photo;
            document.getElementById('detailLocation').textContent = moment.location;
            document.getElementById('detailDate').textContent = formattedDate;
            
            if (moment.caption) {
                document.getElementById('detailCaptionContainer').style.display = 'block';
                document.getElementById('detailCaption').textContent = moment.caption;
            } else {
                document.getElementById('detailCaptionContainer').style.display = 'none';
            }

            // Display tagged friends
            if (moment.taggedFriends && moment.taggedFriends.length > 0) {
                document.getElementById('detailTaggedContainer').style.display = 'block';
                const taggedContainer = document.getElementById('detailTagged');
                taggedContainer.innerHTML = '';
                
                moment.taggedFriends.forEach(friend => {
                    const tag = document.createElement('div');
                    tag.style.cssText = 'display: inline-flex; align-items: center; gap: 0.5rem; background: white; padding: 0.5rem 0.75rem; border-radius: 20px; border: 2px solid #e2e8f0; font-size: 0.85rem; font-weight: 600; color: #2d3748;';
                    tag.innerHTML = `<span style="font-size: 1.2rem;">${friend.avatar}</span><span>${friend.name}</span>`;
                    taggedContainer.appendChild(tag);
                });
            } else {
                document.getElementById('detailTaggedContainer').style.display = 'none';
            }
            
            // Show modal
            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function filterGallery(category) {
            switchView('gallery');
            switchGalleryTab(category);
        }

        // Map initialization
        function initMap() {
            const mapDiv = document.getElementById('map');
            
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }

            if (moments.length === 0) {
                mapDiv.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: white; border-radius: 25px;">
                        <div class="empty-state">
                            <div class="icon">üó∫Ô∏è</div>
                            <h3>Carte vide</h3>
                            <p>Capture des moments pour les voir appara√Ætre ici !</p>
                        </div>
                    </div>
                `;
                return;
            }

            const geoMoments = moments.filter(m => m.position && m.position.lat && m.position.lng);
            
            if (geoMoments.length === 0) {
                mapDiv.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: white; border-radius: 25px;">
                        <div class="empty-state">
                            <div class="icon">üìç</div>
                            <h3>Pas de positions GPS</h3>
                            <p>Active la g√©olocalisation pour voir tes spots sur la carte</p>
                        </div>
                    </div>
                `;
                return;
            }

            mapDiv.innerHTML = '';

            const bounds = geoMoments.map(m => [m.position.lat, m.position.lng]);
            
            mapInstance = L.map('map', {
                zoomControl: true,
                attributionControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(mapInstance);

            markers = [];
            geoMoments.forEach(moment => {
                const iconHtml = `
                    <div style="
                        background: ${categoryConfig[moment.category].color};
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.8rem;
                        border: 4px solid white;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    ">
                        ${categoryConfig[moment.category].icon}
                    </div>
                `;

                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-marker',
                    iconSize: [45, 45],
                    iconAnchor: [22.5, 22.5],
                    popupAnchor: [0, -22.5]
                });

                const marker = L.marker([moment.position.lat, moment.position.lng], {
                    icon: customIcon
                }).addTo(mapInstance);

                const date = new Date(moment.date);
                const formattedDate = date.toLocaleDateString('fr-FR', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric'
                });

                const popupContent = `
                    <img src="${moment.photo}" class="popup-image" alt="${moment.category}">
                    <div class="popup-content">
                        <div class="popup-category">${categoryConfig[moment.category].icon} ${categoryConfig[moment.category].label}</div>
                        <div class="popup-location">üìç ${moment.location}</div>
                        <div style="font-size: 0.75rem; color: #a0aec0;">üìÖ ${formattedDate}</div>
                        ${moment.caption ? `<div class="popup-caption">${moment.caption}</div>` : ''}
                    </div>
                `;

                marker.bindPopup(popupContent, {
                    maxWidth: 220,
                    className: 'custom-popup'
                });

                markers.push(marker);
            });

            if (bounds.length === 1) {
                mapInstance.setView(bounds[0], 13);
            } else {
                mapInstance.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
